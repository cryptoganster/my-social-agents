name: Dependabot Auto-Fix Lockfile

on:
  pull_request:
    paths:
      - 'package.json'
      - 'package-lock.json'
      - 'apps/*/package.json'
      - 'apps/*/package-lock.json'

permissions:
  contents: write
  pull-requests: write

jobs:
  fix-lockfile:
    name: Fix npm Lockfile
    runs-on: ubuntu-latest
    if: github.actor == 'dependabot[bot]'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Check for lockfile issues
        id: check
        run: |
          echo "Checking for package.json and package-lock.json sync issues..."

          # Try to install dependencies
          if npm ci 2>&1 | tee npm-ci.log; then
            echo "‚úÖ Lockfile is in sync"
            echo "needs_fix=false" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Lockfile is out of sync"
            echo "needs_fix=true" >> $GITHUB_OUTPUT
            
            # Check if it's a lockfile issue
            if grep -q "package-lock.json" npm-ci.log || grep -q "ELOCKVERIFY" npm-ci.log; then
              echo "fix_type=lockfile" >> $GITHUB_OUTPUT
            else
              echo "fix_type=other" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Fix lockfile
        if: steps.check.outputs.needs_fix == 'true' && steps.check.outputs.fix_type == 'lockfile'
        run: |
          echo "Regenerating package-lock.json..."

          # Remove old lockfile
          rm -f package-lock.json

          # Regenerate lockfile
          npm install --package-lock-only

          echo "‚úÖ Lockfile regenerated"

      - name: Verify fix
        if: steps.check.outputs.needs_fix == 'true' && steps.check.outputs.fix_type == 'lockfile'
        run: |
          echo "Verifying lockfile fix..."

          if npm ci; then
            echo "‚úÖ Lockfile is now valid"
          else
            echo "‚ùå Lockfile still has issues"
            exit 1
          fi

      - name: Commit lockfile fix
        if: steps.check.outputs.needs_fix == 'true' && steps.check.outputs.fix_type == 'lockfile'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          if git diff --quiet package-lock.json; then
            echo "No changes to commit"
          else
            git add package-lock.json
            git commit -m "chore: fix package-lock.json sync issue"
            git push
            echo "‚úÖ Lockfile fix committed and pushed"
          fi

      - name: Comment on PR
        if: steps.check.outputs.needs_fix == 'true' && steps.check.outputs.fix_type == 'lockfile'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'üîß **Lockfile Auto-Fix**\n\nThe `package-lock.json` was out of sync with `package.json`. I\'ve regenerated it automatically.\n\n‚úÖ The lockfile is now in sync and CI should pass.'
            })

      - name: Comment on other issues
        if: steps.check.outputs.needs_fix == 'true' && steps.check.outputs.fix_type == 'other'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '‚ö†Ô∏è **Dependency Issue Detected**\n\nThere\'s an issue with the dependencies that couldn\'t be auto-fixed. Please review the CI logs and fix manually.\n\nCommon causes:\n- Conflicting dependency versions\n- Missing peer dependencies\n- Invalid package.json syntax'
            })
