#!/usr/bin/env bash

# Pre-push safety hook - Blocks dangerous push operations and enforces rebase strategy
# This runs BEFORE the main pre-push hook

set -e

# Get the command line arguments
# $1 = remote name (e.g., "origin")
# $2 = remote URL

remote_name="$1"
remote_url="$2"

# Get current branch
current_branch=$(git rev-parse --abbrev-ref HEAD)

# Skip checks for master branch (should never push to master directly anyway)
if [ "$current_branch" = "master" ]; then
  exit 0
fi

# Check 1: Verify branch is rebased on latest origin/master
echo "üîç Checking if branch is rebased on latest origin/master..."

# Fetch latest master silently
git fetch origin master --quiet 2>/dev/null || true

# Get merge base between current branch and origin/master
merge_base=$(git merge-base HEAD origin/master 2>/dev/null || echo "")
origin_master_sha=$(git rev-parse origin/master 2>/dev/null || echo "")

if [ -n "$merge_base" ] && [ -n "$origin_master_sha" ]; then
  if [ "$merge_base" != "$origin_master_sha" ]; then
    echo ""
    echo "‚ùå ERROR: Branch is not rebased on latest origin/master!"
    echo ""
    echo "üö´ BLOCKED: Your branch is behind origin/master"
    echo ""
    echo "Your branch needs to be rebased on the latest master before pushing."
    echo ""
    echo "‚úÖ REQUIRED STEPS:"
    echo "   1. Fetch latest master:"
    echo "      git fetch origin"
    echo ""
    echo "   2. Rebase your branch:"
    echo "      git rebase origin/master"
    echo ""
    echo "   3. Resolve conflicts if any:"
    echo "      # Edit conflicted files"
    echo "      git add <resolved-files>"
    echo "      git rebase --continue"
    echo ""
    echo "   4. Push with force-with-lease:"
    echo "      git push --force-with-lease origin $current_branch"
    echo ""
    echo "Current state:"
    echo "  Your branch base: $(git rev-parse --short $merge_base)"
    echo "  Latest master:    $(git rev-parse --short $origin_master_sha)"
    echo "  Commits behind:   $(git rev-list --count $merge_base..origin/master)"
    echo ""
    exit 1
  fi
fi

# Check 2: Warn about force push (but allow it after rebase)
# After a successful rebase, force push is expected and necessary
# We've already verified the branch is rebased, so force push is safe
echo "‚úÖ Branch is properly rebased on origin/master"
echo "üí° Force push is allowed after rebase (use --force-with-lease)"
exit 0
