#!/usr/bin/env bash
. "$(dirname -- "$0")/_/husky.sh"

set -e

# ============================================================================
# SAFETY CHECK: Block commits directly on protected branches
# ============================================================================

current_branch=$(git rev-parse --abbrev-ref HEAD)
protected_branches=("master" "main" "production" "prod")

for branch in "${protected_branches[@]}"; do
  if [ "$current_branch" = "$branch" ]; then
    echo ""
    echo "‚ùå ERROR: Direct commits to '$branch' are not allowed!"
    echo ""
    echo "üö´ BLOCKED OPERATION: git commit on $branch"
    echo ""
    echo "All work must be done in feature branches."
    echo ""
    echo "‚úÖ CORRECT WORKFLOW:"
    echo "   1. Create a feature branch:"
    echo "      git checkout -b feature/your-feature-name"
    echo ""
    echo "   2. Make your changes and commit:"
    echo "      git add ."
    echo "      git commit -m 'feat: your changes'"
    echo ""
    echo "   3. Push and create a Pull Request:"
    echo "      git push -u origin feature/your-feature-name"
    echo "      gh pr create --base master"
    echo ""
    echo "Why this rule exists:"
    echo "  ‚Ä¢ Ensures all changes go through Pull Request review"
    echo "  ‚Ä¢ Maintains clean history with atomic feature branches"
    echo "  ‚Ä¢ Prevents accidental commits to protected branches"
    echo "  ‚Ä¢ Enforces team collaboration and code review"
    echo ""
    echo "Current branch: $current_branch"
    echo ""
    exit 1
  fi
done

# ============================================================================
# CODE QUALITY CHECKS
# ============================================================================

# Run lint-staged for incremental checks
npx lint-staged

# Run lint check (will fail if there are errors)
npm run lint:check

# Run TypeScript type checking
npm run typecheck

# Run format (auto-fix formatting issues)
npm run format

# Run format check (will fail if files are not formatted)
npm run format:check